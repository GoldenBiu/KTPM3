{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="{% static 'CSS/dichvu.css' %}">

        <!--css-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link href="{% static 'app/css/style.css' %}" rel="stylesheet" />
        <link href="{% static 'app/css/owl.caroysel.min.css' %}" rel="stylesheet" />
        <link href="{% static 'app/css/all.min.css' %}" rel="stylesheet" />
        <!-- js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
      
        <script src="{% static 'app/js/s3.js' %}"> </script>
        <script src="{% static 'app/js/all.min.js' %}"> </script>
        <script src="{% static 'app/js/m√Ωcript.js' %}"> </script>

        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
        
        <style>
            .action-buttons {
                display: flex;
                gap: 5px;
            }
            
            @media (max-width: 768px) {
                .action-buttons {
                    flex-direction: column;
                }
            }
        </style>
    </head>
   
    <body>
        <header class="header">
            <div class="menu-toggle">‚ò∞</div>
            <div class="header-title">Nh√† tr·ªç C·∫ßn Th∆°</div>

            
          </div>
          </header>
        
          <div class="sidebar">
               <div class="logo_content">
                
                <div class="logo">
                  <div class="icon">
                    <img src="{% static '/imag/moi.jpg' %}" alt="Logo">
                  </div>
                  <div class="logo_name">Xin ch√†o, admin</div>
                </div>
                
            </div>

           <!--<div class="logo_name">Xin ch√†o, Admin</div> -->

           <ul class="nav_list">
            <li>
              <a href="{% url 'menu' %}">
                <span class="icon">üè†</span>
                <span class="link_name">Trang ch·ªß</span>
              </a>
            </li>
            <li>
              <a href="{% url 'quan_ly_khach_hang' %}">
                <span class="icon">üßë‚Äçüíº</span>
                <span class="link_name">Qu·∫£n l√Ω kh√°ch h√†ng</span>
              </a>
            </li>
            <li>
              <a href="{% url 'doanh_thu' %}"> 
                <span class="icon">üí∞</span>
                <span class="link_name">Doanh thu</span>
              </a>
            </li>
            <li>
              <a href="{% url 'dich_vu' %}">
                <span class="icon">üí°</span>
                <span class="link_name">D·ªãch v·ª•</span>
              </a>
            </li>
            <li>
              <a href="{% url 'hoa_don' %}">
                <span class="icon">üßæ</span>
                <span class="link_name">H√≥a ƒë∆°n</span>
              </a>
            </li>
            <li>
              <a href="{% url 'quan_li_hop_dong' %}">
                <span class="icon">üìÇ</span>
                <span class="link_name">Qu·∫£n l√Ω h·ª£p ƒë·ªìng</span>
              </a>
            </li>
            <li>
              <a href="{% url 'dang_xuat' %}" class="logout-link">
                <span class="icon"><i class="fas fa-sign-out-alt"></i></span>
                <span class="link_name">ƒêƒÉng Xu·∫•t</span>
              </a>
            </li>
          </ul>
          </div>
    




          <div class="content flex-grow-1 p-4">
            <div class="topbar d-flex justify-content-between align-items-center mb-4"></div>
    
            <!-- Hi·ªÉn th·ªã th√¥ng b√°o -->
            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
    
            <!-- Qu·∫£n l√Ω ƒëi·ªán n∆∞·ªõc -->
            <div class="container">
                <div class="cf-title-03">
                    <h3>Qu·∫£n l√Ω ƒëi·ªán n∆∞·ªõc</h3>
                </div>
                <div id="product-list">
                    <!-- ƒêi·ªán v√† N∆∞·ªõc s·∫£n ph·∫©m v·ªõi gi√° ƒë·ªông t·ª´ database -->
                    <div class="product">
                        <input type="text" value="ƒêi·ªán" placeholder="T√™n s·∫£n ph·∫©m" readonly>
                        <input type="number" value="{{ dien_price }}" placeholder="Gi√° c≈© (VNƒê)" readonly class="old-price" step="1">
                        <input type="number" value="" placeholder="Nh·∫≠p gi√° m·ªõi (VNƒê)" step="1" min="0">
                        <div class="btn-group">
                            <button class="update-btn" onclick="updateProduct(this)">C·∫≠p nh·∫≠t</button>
                        </div>
                    </div>
                    <div class="product">
                        <input type="text" value="N∆∞·ªõc" placeholder="T√™n s·∫£n ph·∫©m" readonly>
                        <input type="number" value="{{ nuoc_price }}" placeholder="Gi√° c≈© (VNƒê)" readonly class="old-price" step="1">
                        <input type="number" value="" placeholder="Nh·∫≠p gi√° m·ªõi (VNƒê)" step="1" min="0">
                        <div class="btn-group">
                            <button class="update-btn" onclick="updateProduct(this)">C·∫≠p nh·∫≠t</button>
                        </div>
                    </div>
                    
                    <!-- Hidden form for submitting product updates -->
                    <form id="product-update-form" method="POST" action="{% url 'cap_nhat_gia_dien_nuoc' %}" style="display: none;">
                        {% csrf_token %}
                        <input type="hidden" name="loai_dich_vu" id="loai_dich_vu">
                        <input type="hidden" name="gia_moi" id="gia_moi">
                    </form>
                </div>
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i> 
                    Gi√° ƒëi·ªán v√† n∆∞·ªõc s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng cho c√°c ch·ªâ s·ªë m·ªõi. Nh·∫•n v√†o 
                    <button type="button" class="btn btn-link p-0 align-baseline text-decoration-none" data-bs-toggle="modal" data-bs-target="#meterReadingModal">
                        ƒë√¢y
                    </button> ƒë·ªÉ c·∫≠p nh·∫≠t ch·ªâ s·ªë ƒë·ªìng h·ªì.
                </div>
                
                <!-- Hi·ªÉn th·ªã d·ªØ li·ªáu ƒë·ªçc ƒëi·ªán n∆∞·ªõc g·∫ßn ƒë√¢y -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">D·ªØ li·ªáu ƒë·ªçc ƒëi·ªán n∆∞·ªõc g·∫ßn ƒë√¢y</h5>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#meterReadingModal">
                            <i class="fas fa-plus-circle me-1"></i> C·∫≠p nh·∫≠t ch·ªâ s·ªë m·ªõi
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>Ph√≤ng</th>
                                        <th>Th√°ng</th>
                                        <th>Ch·ªâ s·ªë ƒëi·ªán c≈©/m·ªõi</th>
                                        <th>Ti√™u th·ª• ƒëi·ªán</th>
                                        <th>Ch·ªâ s·ªë n∆∞·ªõc c≈©/m·ªõi</th>
                                        <th>Ti√™u th·ª• n∆∞·ªõc</th>
                                        <th>T·ªïng ti·ªÅn</th>
                                        <th>Tr·∫°ng th√°i</th>
                                        <th>Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reading in recent_readings %}
                                    <tr>
                                        <td>{{ reading.room_info }}</td>
                                        <td>{{ reading.period }}</td>
                                        <td>{{ reading.old_electric }} / {{ reading.new_electric }}</td>
                                        <td>{{ reading.electric_usage }}</td>
                                        <td>{{ reading.old_water }} / {{ reading.new_water }}</td>
                                        <td>{{ reading.water_usage }}</td>
                                        <td>{{ reading.total_amount }}</td>
                                        <td>{{ reading.status }}</td>
                                        <td>
                                            <div class="action-buttons">
                                                <a href="{% url 'cap_nhat_hoa_don' %}?chi_so_id={{ reading.chi_so_id }}" class="btn btn-sm btn-primary">
                                                    <i class="fas fa-edit"></i> C·∫≠p nh·∫≠t
                                                </a>
                                                <a href="{% url 'xoa_chi_so_dien_nuoc' reading.chi_so_id %}" class="btn btn-sm btn-danger" onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi n√†y kh√¥ng?');">
                                                    <i class="fas fa-trash"></i> X√≥a
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- B·∫£ng l·ªãch s·ª≠ gi√° ƒëi·ªán n∆∞·ªõc -->
                <div class="card mt-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">L·ªãch s·ª≠ gi√° ƒëi·ªán n∆∞·ªõc</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Lo·∫°i d·ªãch v·ª•</th>
                                        <th>Gi√° c≈©</th>
                                        <th>Gi√° m·ªõi</th>
                                        <th>Ng√†y c·∫≠p nh·∫≠t</th>
                                        <th>Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for gia in dien_price_history %}
                                    <tr>
                                        <td><strong>ƒêi·ªán</strong></td>
                                        <td>{{ gia.GiaCu|floatformat:0 }} VNƒê</td>
                                        <td>{{ gia.GiaMoi|floatformat:0 }} VNƒê</td>
                                        <td>{{ gia.NgayCapNhat|date:"d/m/Y H:i" }}</td>
                                        <td>
                                            <a href="{% url 'xoa_gia_dien_nuoc' gia.GiaID %}" class="btn btn-sm btn-danger" onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi gi√° n√†y kh√¥ng?');">
                                                <i class="fas fa-trash"></i> X√≥a
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    
                                    {% for gia in nuoc_price_history %}
                                    <tr>
                                        <td><strong>N∆∞·ªõc</strong></td>
                                        <td>{{ gia.GiaCu|floatformat:0 }} VNƒê</td>
                                        <td>{{ gia.GiaMoi|floatformat:0 }} VNƒê</td>
                                        <td>{{ gia.NgayCapNhat|date:"d/m/Y H:i" }}</td>
                                        <td>
                                            <a href="{% url 'xoa_gia_dien_nuoc' gia.GiaID %}" class="btn btn-sm btn-danger" onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi gi√° n√†y kh√¥ng?');">
                                                <i class="fas fa-trash"></i> X√≥a
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Modal C·∫≠p nh·∫≠t ch·ªâ s·ªë ƒëi·ªán n∆∞·ªõc -->
                <div class="modal fade" id="meterReadingModal" tabindex="-1" aria-labelledby="meterReadingModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="meterReadingModalLabel">C·∫≠p nh·∫≠t ch·ªâ s·ªë ƒëi·ªán n∆∞·ªõc</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form action="{% url 'cap_nhat_chi_so_dien_nuoc' %}" method="POST" id="meter-reading-form">
                                    {% csrf_token %}
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="phong_id" class="form-label">Ch·ªçn ph√≤ng</label>
                                            <select class="form-select" id="phong_id" name="phong_id" required>
                                                <option value="">-- Ch·ªçn ph√≤ng --</option>
                                                {% for phong in phong_list %}
                                                    <option value="{{ phong.PhongID }}">{{ phong.DayPhong }}{{ phong.SoPhong }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="thang_nam" class="form-label">Th√°ng/NƒÉm</label>
                                            <input type="text" class="form-control" id="thang_nam" name="thang_nam" 
                                                  placeholder="MM/YYYY" required pattern="[0-9]{2}/[0-9]{4}"
                                                  value="{{ current_month_year }}">
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="card bg-light mb-3">
                                                <div class="card-header">Ch·ªâ s·ªë ƒëi·ªán</div>
                                                <div class="card-body">
                                                    <div class="row g-2">
                                                        <div class="col-6">
                                                            <label for="chi_so_dien_cu" class="form-label">Ch·ªâ s·ªë c≈©</label>
                                                            <input type="number" class="form-control" id="chi_so_dien_cu" name="chi_so_dien_cu" 
                                                                  min="0" value="0" onchange="calculateElectricUsage()">
                                                        </div>
                                                        <div class="col-6">
                                                            <label for="chi_so_dien_moi" class="form-label">Ch·ªâ s·ªë m·ªõi</label>
                                                            <input type="number" class="form-control" id="chi_so_dien_moi" name="chi_so_dien_moi" 
                                                                  min="0" value="0" onchange="calculateElectricUsage()">
                                                        </div>
                                                        <div class="col-12 mt-2">
                                                            <div class="alert alert-info mb-0 text-center">
                                                                <strong>Ti√™u th·ª•: <span id="electric_usage">0</span> kWh</strong><br>
                                                                <strong>Th√†nh ti·ªÅn: <span id="electric_cost">0</span> VNƒê</strong>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="card bg-light mb-3">
                                                <div class="card-header">Ch·ªâ s·ªë n∆∞·ªõc</div>
                                                <div class="card-body">
                                                    <div class="row g-2">
                                                        <div class="col-6">
                                                            <label for="chi_so_nuoc_cu" class="form-label">Ch·ªâ s·ªë c≈©</label>
                                                            <input type="number" class="form-control" id="chi_so_nuoc_cu" name="chi_so_nuoc_cu" 
                                                                  min="0" value="0" onchange="calculateWaterUsage()">
                                                        </div>
                                                        <div class="col-6">
                                                            <label for="chi_so_nuoc_moi" class="form-label">Ch·ªâ s·ªë m·ªõi</label>
                                                            <input type="number" class="form-control" id="chi_so_nuoc_moi" name="chi_so_nuoc_moi" 
                                                                  min="0" value="0" onchange="calculateWaterUsage()">
                                                        </div>
                                                        <div class="col-12 mt-2">
                                                            <div class="alert alert-info mb-0 text-center">
                                                                <strong>Ti√™u th·ª•: <span id="water_usage">0</span> m¬≥</strong><br>
                                                                <strong>Th√†nh ti·ªÅn: <span id="water_cost">0</span> VNƒê</strong>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-12">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title">T·ªïng ti·ªÅn d·ªãch v·ª•</h5>
                                                    <h3 class="text-primary"><span id="total_cost">0</span> VNƒê</h3>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('meter-reading-form').submit()">L∆∞u ch·ªâ s·ªë</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div><br>
    
            <!-- Qu·∫£n l√Ω d·ªãch v·ª• -->
            <div class="container">
                <div class="cf-title-03">
                    <h3>Qu·∫£n l√Ω d·ªãch v·ª•</h3>
                </div>
                <div id="service-list">
                    <!-- Iterate through services from database -->
                    {% for service in services %}
                    <div class="service">
                        <input type="text" value="{{ service.TenDichVu }}" placeholder="T√™n s·∫£n ph·∫©m" readonly class="product-name">
                        <input type="number" value="{{ service.GiaCuDichVu }}" placeholder="Gi√° c≈© (VNƒê)" readonly class="old-price" step="1">
                        <input type="number" value="{{ service.GiaDichVu }}" placeholder="Gi√° m·ªõi (VNƒê)" readonly class="new-price" step="1">
                        <div class="btn-group">
                            <button class="edit-btn" onclick="editService(this, {{ service.DichVuID }})">Ch·ªânh S·ª≠a</button>
                            <button class="delete-btn" onclick="deleteService(this, {{ service.DichVuID }})">X√≥a</button>
                        </div>
                    </div>
                    {% empty %}
                    <!-- Display if no services exist -->
                    <p>Ch∆∞a c√≥ d·ªãch v·ª• n√†o. H√£y th√™m d·ªãch v·ª• m·ªõi!</p>
                    {% endfor %}
                </div>
                <button class="add-btn" onclick="addServiceForm()">‚ûï Th√™m d·ªãch v·ª•</button>
                <div class="cf-title-01">
                    <h6>T·ªîNG: <span id="total-price">0</span></h6>
                </div>
                
                <!-- Form for adding/updating service (hidden by default) -->
                <div id="service-form" style="display: none;" class="mt-4 p-3 border rounded">
                    <h4 id="form-title">Th√™m D·ªãch V·ª• M·ªõi</h4>
                    <form action="{% url 'cap_nhat_dich_vu' %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" id="service-id" name="service_id">
                        <div class="mb-3">
                            <label for="ten-dich-vu" class="form-label">T√™n d·ªãch v·ª•</label>
                            <input type="text" class="form-control" id="ten-dich-vu" name="ten_dich_vu" required>
                        </div>
                        <div class="mb-3">
                            <label for="gia-dich-vu" class="form-label">Gi√° d·ªãch v·ª• <span class="text-muted">(Khi c·∫≠p nh·∫≠t, gi√° hi·ªán t·∫°i s·∫Ω tr·ªü th√†nh gi√° c≈©)</span></label>
                            <input type="number" class="form-control" id="gia-dich-vu" name="gia_dich_vu" step="1" min="0" required>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-primary">L∆∞u</button>
                            <button type="button" class="btn btn-secondary" onclick="hideServiceForm()">H·ªßy</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        const toggle = document.querySelector('.menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        toggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });

        // Show form to add a new service
        function addServiceForm() {
            document.getElementById('form-title').textContent = 'Th√™m D·ªãch V·ª• M·ªõi';
            document.getElementById('service-id').value = '';
            document.getElementById('ten-dich-vu').value = '';
            document.getElementById('gia-dich-vu').value = '';
            document.getElementById('service-form').style.display = 'block';
            
            // Set focus to name field
            setTimeout(() => {
                document.getElementById('ten-dich-vu').focus();
            }, 100);
        }
        
        // Hide the service form
        function hideServiceForm() {
            document.getElementById('service-form').style.display = 'none';
        }
        
        // Add keyboard navigation for form fields
        document.addEventListener('DOMContentLoaded', function() {
            // Add keyboard navigation for the service name input
            const nameInput = document.querySelector('input[name="ten_dich_vu"]');
            if (nameInput) {
                nameInput.addEventListener('keydown', function(e) {
                    // Allow Escape key to hide the form
                    if (e.key === 'Escape') {
                        hideServiceForm();
                    }
                    
                    // Move to price input on Enter
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.getElementById('gia-dich-vu').focus();
                    }
                });
            }
            
            // Add keyboard navigation for the price input
            const priceInput = document.querySelector('input[name="gia_dich_vu"]');
            if (priceInput) {
                priceInput.addEventListener('keydown', function(e) {
                    // Allow Escape key to hide the form
                    if (e.key === 'Escape') {
                        hideServiceForm();
                    }
                    
                    // Submit form on Enter
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.form.submit();
                    }
                });
            }
            
            calculateTotal();
        });

        // Calculate the total price of services
        function calculateTotal() {
            const newPriceInputs = document.querySelectorAll('.new-price');
            let total = 0;
    
            newPriceInputs.forEach(input => {
                // With number inputs, we can directly get the value as a number
                const price = parseFloat(input.value) || 0;
                total += price;
            });
    
            // Display total
            document.getElementById('total-price').textContent = total;
        }

        function updateProduct(button) {
            let productDiv = button.closest(".product");
            let inputs = productDiv.querySelectorAll("input");
            
            if (button.innerText === "C·∫≠p nh·∫≠t") {
                let name = inputs[0].value.trim();
                let newPrice = inputs[2].value.trim();
                
                if (name === "" || newPrice === "") {
                    alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                    return;
                }
                
                // Map product name to LoaiDichVu
                let loaiDichVu = name === "ƒêi·ªán" ? "Dien" : (name === "N∆∞·ªõc" ? "Nuoc" : "");
                if (!loaiDichVu) {
                    alert("Lo·∫°i d·ªãch v·ª• kh√¥ng h·ª£p l·ªá! Ch·ªâ h·ªó tr·ª£ c·∫≠p nh·∫≠t gi√° ƒêi·ªán v√† N∆∞·ªõc.");
                    return;
                }
                
                // Confirm with user
                if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën c·∫≠p nh·∫≠t gi√° ${name} th√†nh ${newPrice} VND/Kw`)) {
                    // Set values in hidden form
                    document.getElementById('loai_dich_vu').value = loaiDichVu;
                    document.getElementById('gia_moi').value = newPrice;
                    
                    // Submit the form
                    document.getElementById('product-update-form').submit();
                }
            } else {
                // Switch to edit mode
                inputs[2].removeAttribute("readonly");
                button.innerText = "C·∫≠p nh·∫≠t";
                button.classList.remove("edi-btn");
                button.classList.add("update-btn");
                inputs[2].focus();
            }
        }

        // Show form to edit existing service
        function editService(button, serviceId) {
            const serviceDiv = button.closest('.service');
            const inputs = serviceDiv.querySelectorAll('input');
            const name = inputs[0].value;
            const oldPrice = inputs[1].value; // This is the old price display
            const currentPrice = inputs[2].value; // This is the current price
            
            document.getElementById('form-title').textContent = 'C·∫≠p Nh·∫≠t D·ªãch V·ª•';
            document.getElementById('service-id').value = serviceId;
            document.getElementById('ten-dich-vu').value = name;
            
            // Just use the current price directly - no need to extract numbers
            // since we're using number input type
            document.getElementById('gia-dich-vu').value = currentPrice;
            
            document.getElementById('service-form').style.display = 'block';
            
            // Set focus to the price field for easy editing
            setTimeout(() => {
                const priceInput = document.getElementById('gia-dich-vu');
                priceInput.focus();
            }, 100);
        }
        
        // Delete a service - using the correct URL
        function deleteService(button, serviceId) {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d·ªãch v·ª• n√†y?")) {
                window.location.href = `/delete-service/${serviceId}/`;
            }
        }
        
        // Calculate electricity usage and cost
        function calculateElectricUsage() {
            const oldReading = parseInt(document.getElementById('chi_so_dien_cu').value) || 0;
            const newReading = parseInt(document.getElementById('chi_so_dien_moi').value) || 0;
            
            // Ensure new reading is not less than old reading
            if (newReading < oldReading) {
                alert('Ch·ªâ s·ªë ƒëi·ªán m·ªõi kh√¥ng th·ªÉ nh·ªè h∆°n ch·ªâ s·ªë c≈©');
                document.getElementById('chi_so_dien_moi').value = oldReading;
                return;
            }
            
            const usage = newReading - oldReading;
            
            // Get current electricity price from the first product in the list (ƒêi·ªán)
            const electricityPrice = {{ dien_price }} || 0;
            
            const cost = usage * electricityPrice;
            
            // Update display
            document.getElementById('electric_usage').textContent = usage;
            document.getElementById('electric_cost').textContent = cost.toLocaleString('vi-VN');
            
            // Update total cost
            calculateTotalCost();
        }
        
        // Calculate water usage and cost
        function calculateWaterUsage() {
            const oldReading = parseInt(document.getElementById('chi_so_nuoc_cu').value) || 0;
            const newReading = parseInt(document.getElementById('chi_so_nuoc_moi').value) || 0;
            
            // Ensure new reading is not less than old reading
            if (newReading < oldReading) {
                alert('Ch·ªâ s·ªë n∆∞·ªõc m·ªõi kh√¥ng th·ªÉ nh·ªè h∆°n ch·ªâ s·ªë c≈©');
                document.getElementById('chi_so_nuoc_moi').value = oldReading;
                return;
            }
            
            const usage = newReading - oldReading;
            
            // Get current water price from the second product in the list (N∆∞·ªõc)
            const waterPrice = {{ nuoc_price }} || 0;
            
            const cost = usage * waterPrice;
            
            // Update display
            document.getElementById('water_usage').textContent = usage;
            document.getElementById('water_cost').textContent = cost.toLocaleString('vi-VN');
            
            // Update total cost
            calculateTotalCost();
        }
        
        // Calculate total cost (electricity + water)
        function calculateTotalCost() {
            const electricCost = parseInt(document.getElementById('electric_cost').textContent.replace(/\D/g, '')) || 0;
            const waterCost = parseInt(document.getElementById('water_cost').textContent.replace(/\D/g, '')) || 0;
            
            const totalCost = electricCost + waterCost;
            
            // Update display
            document.getElementById('total_cost').textContent = totalCost.toLocaleString('vi-VN');
        }
        
        // Load previous readings when room is selected
        document.addEventListener('DOMContentLoaded', function() {
            const roomSelect = document.getElementById('phong_id');
            if (roomSelect) {
                roomSelect.addEventListener('change', function() {
                    const roomId = this.value;
                    if (!roomId) return;
                    
                    // Reset the form
                    document.getElementById('chi_so_dien_cu').value = 0;
                    document.getElementById('chi_so_dien_moi').value = 0;
                    document.getElementById('chi_so_nuoc_cu').value = 0;
                    document.getElementById('chi_so_nuoc_moi').value = 0;
                    
                    // Recalculate after reset
                    calculateElectricUsage();
                    calculateWaterUsage();
                });
            }
            
            // Initialize calculations
            const electricForm = document.getElementById('chi_so_dien_cu');
            const waterForm = document.getElementById('chi_so_nuoc_cu');
            if (electricForm && waterForm) {
                calculateElectricUsage();
                calculateWaterUsage();
                
                // Set current date in MM/YYYY format if not already set
                const dateField = document.getElementById('thang_nam');
                if (dateField && !dateField.value) {
                    const now = new Date();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const year = now.getFullYear();
                    dateField.value = `${month}/${year}`;
                }
            }
        });
    </script>
    </body>
    </html>