{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qu·∫£n L√Ω Kh√°ch H√†ng</title>
<link rel="stylesheet" href="{% static 'CSS/hoadon.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="{% static 'app/css/style.css' %}" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>

<!--css-->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link href="{% static 'app/css/style.css' %}" rel="stylesheet" />
<link href="{% static 'app/css/owl.caroysel.min.css' %}" rel="stylesheet" />
<link href="{% static 'app/css/all.min.css' %}" rel="stylesheet" />
<!-- js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>

<script src="{% static 'app/js/s3.js' %}"> </script>
<script src="{% static 'app/js/all.min.js' %}"> </script>
<script src="{% static 'app/js/m√Ωcript.js' %}"> </script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
</head>
<body>
<header class="header">
    <div class="menu-toggle">‚ò∞</div>
    <div class="header-title">Nh√† tr·ªç C·∫ßn Th∆°</div>
    {% comment %} <div class="search-bar">
        <input type="text" placeholder="T√¨m ki·∫øm..." />
        <button class="timkiem" type="submit">üîç</button>
    </div> {% endcomment %}

    

</header><br><br>
<div class="sidebar">
    <div class="logo_content">
        <div class="logo">
            <div class="icon">
                <img src="{% static '/imag/moi.jpg' %}" alt="Logo">
            </div>
            <div class="logo_name">Xin ch√†o, admin</div>
        </div>
    </div>
    <ul class="nav_list">
        <li>
        <a href="{% url 'menu' %}">
            <span class="icon">üè†</span>
            <span class="link_name">Trang ch·ªß</span>
        </a>
        </li>
        <li>
        <a href="{% url 'quan_ly_khach_hang' %}">
            <span class="icon">üßë‚Äçüíº</span>
            <span class="link_name">Qu·∫£n l√Ω kh√°ch h√†ng</span>
        </a>
        </li>
        <li>
        <a href="{% url 'doanh_thu' %}">
            <span class="icon">üí∞</span>
            <span class="link_name">Doanh thu</span>
        </a>
        </li>
        <li>
        <a href="{% url 'dich_vu' %}">
            <span class="icon">üí°</span>
            <span class="link_name">D·ªãch v·ª•</span>
        </a>
        </li>
        <li>
        <a href="{% url 'hoa_don' %}">
            <span class="icon">üßæ</span>
            <span class="link_name">H√≥a ƒë∆°n</span>
        </a>
        </li>
        <li>
        <a href="{% url 'quan_li_hop_dong' %}">
            <span class="icon">üìÇ</span>
            <span class="link_name">Qu·∫£n l√Ω h·ª£p ƒë·ªìng</span>
        </a>
        </li>
        <li>
        <a href="{% url 'dang_xuat' %}" class="logout-link">
            <span class="icon"><i class="fas fa-sign-out-alt"></i></span>
            <span class="link_name">ƒêƒÉng Xu·∫•t</span>
        </a>
        </li>
    </ul>
</div>

<div class="content container">
    <div class="mt-4">
    <div class="rong">   
        
<div class="cf-title-12">
<h3>DANH S√ÅCH H√ìA ƒê∆†N</h3>
</div>
        <div class="room-list-header">   
        <nav class="doi">
        <div class="select-container">
            <i class="bi bi-house-door icon"></i>
        <select id="dayFilter" onchange="filterInvoices()">
            <option value="T·∫•t c·∫£" disabled selected hidden>D√£y</option>
            <option value="T·∫•t c·∫£">T·∫•t c·∫£</option>
            {% for day in day_phong_list %}
            <option value="{{ day }}">{{ day }}</option>
            {% endfor %}
        </select>
        </div><br>
        <div class="select-container">
        <i class="fa-solid fa-list-ol ico"></i> 
        <select id="roomFilter" onchange="filterInvoices()">
            <option value="T·∫•t c·∫£" disabled selected hidden>S·ªë ph√≤ng</option>
            <option value="T·∫•t c·∫£">T·∫•t c·∫£</option>
            {% for room in so_phong_list %}
            <option value="{{ room }}">{{ room }}</option>
            {% endfor %}
        </select>
    </div><br>

            <div class="search-container">
                <button class="search-btn">
                    <i style="font-weight: bold;">Go</i>
                </button>
                <!--<button class="themphong" onclick="document.location='themphong.html'">+ Th√™m ph√≤ng</button>  --> 
            </div>
    </div>

        
    </nav>
    
    </div>



<div class="content flex-grow-1 p-4">
    <!-- Thanh c√¥ng c·ª• ph√≠a tr√™n -->
    <div class="topbar d-flex justify-content-between align-items-center mb-4">
    
        <div>

        </div>
    </div>

<div class="container mt-4">
    <div class="khachhang">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>D√£y</th>
                    <th>Ph√≤ng</th>
                    <th>T√™n</th>
                    <th>S·ªë ƒêi·ªán Tho·∫°i</th>
                    <th>Ti·ªÅn tr·ªç/Ti·ªÅn n·ª£</th>
                    <th>H√†nh ƒê·ªông</th>
                </tr>
            </thead>
            <tbody id="invoiceTable">
                {% for hoa_don in hoa_don_data %}
                <tr class="invoice-row" data-day="{{ hoa_don.day_phong }}" data-room="{{ hoa_don.so_phong }}">
                    <td>{{ forloop.counter }}</td>
                    <td>{{ hoa_don.day_phong }}</td>
                    <td>{{ hoa_don.so_phong }}</td>
                    <td>{{ hoa_don.ten_khach_hang }}</td>
                    <td>{{ hoa_don.so_dien_thoai }}</td>
                    <td>
                        Ti·ªÅn tr·ªç: {{ hoa_don.tien_phong|floatformat:0 }} VNƒê
                        {% if hoa_don.tien_no > 0 %}
                        <br><span class="text-danger">Ti·ªÅn n·ª£: {{ hoa_don.tien_no|floatformat:0 }} VNƒê</span>
                        <br><span class="text-success">ƒê√£ tr·∫£: {{ hoa_don.tien_tra|floatformat:0 }} VNƒê</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'xem_hoa_don' hoa_don.chi_so_id %}" class="btn xemchitiet">Xem H√≥a ƒê∆°n</a>
                        {% if not hoa_don.da_thanh_toan %}
                        <button class="thanhtoan-btn" onclick="showPaymentForm(this, {{ hoa_don.chi_so_id }}, {{ hoa_don.tong_tien }})">Thanh To√°n</button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu h√≥a ƒë∆°n</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
</div>
</div>
<div id="paymentForm" class="thanh">
<h3>Thanh To√°n</h3>
<form id="payment-form" method="POST" action="">
    {% csrf_token %}
    <input type="hidden" id="chi_so_id" name="chi_so_id">
    <label><input class="da" type="radio" name="payment_status" value="completed" checked> ƒê√£ Thanh To√°n ƒê·∫ßy ƒê·ªß</label><br>
    <label><input type="radio" name="payment_status" value="pending"> Thanh To√°n M·ªôt Ph·∫ßn (Ghi N·ª£)</label><br>
    <div id="debtDetails" style="display:none;">
        <label>T·ªïng ti·ªÅn h√≥a ƒë∆°n:</label>
        <input type="number" id="totalAmount" name="total_amount" readonly><br>
        
        <div id="previousPaymentInfo" style="display:none;">
            <label>ƒê√£ thanh to√°n tr∆∞·ªõc ƒë√≥:</label>
            <input type="number" id="previousAmount" name="previous_amount" readonly><br>
        </div>
        
        <label>S·ªë ti·ªÅn kh√°ch ƒë∆∞a:</label>
        <input type="number" id="debtAmount" name="paid_amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn kh√°ch ƒë∆∞a" oninput="calculateRemaining()"><br>
        
        <label>S·ªë ti·ªÅn s·∫Ω ghi n·ª£:</label>
        <input class="conlai" type="text" id="total" placeholder="S·ªë ti·ªÅn n·ª£ (VNƒê)" readonly><br>
        
        <label>H·∫°n tr·∫£:</label>
        <input type="date" id="dueDate" name="due_date" lang="vi"><br>
    </div>
    <div class="button-container">
        <button type="button" onclick="submitPayment()">X√°c nh·∫≠n</button>   
        <button type="button" onclick="cancelPayment()">H·ªßy</button>
    </div>
</form>
</div>


</div>
</div>  
</div>
<script> 
const toggle = document.querySelector('.menu-toggle');
const sidebar = document.querySelector('.sidebar');

toggle.addEventListener('click', () => {
sidebar.classList.toggle('active');
});
</script>

<script>
function calculateRemaining() {
    const debtAmount = parseFloat(document.getElementById('debtAmount').value) || 0;
    const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
    const previousAmount = parseFloat(document.getElementById('previousAmount').value) || 0;
    
    // Calculate remaining debt based on total, previous payments, and current payment
    const remainingAmount = totalAmount - previousAmount - debtAmount;

    document.getElementById('total').value = remainingAmount.toLocaleString("vi-VN", { style: "currency", currency: "VND" });
}

let currentButton;
let currentChiSoId;
let currentRow;

function showPaymentForm(button, chiSoId, totalAmount) {
    currentButton = button;
    currentChiSoId = chiSoId;
    currentRow = button.closest('tr');

    // Ki·ªÉm tra n·∫øu n√∫t ƒë√£ l√† "ƒê√£ Thanh To√°n" th√¨ kh√¥ng m·ªü form
    if (currentButton.textContent === 'ƒê√£ Thanh To√°n') {
        alert('H√≥a ƒë∆°n n√†y ƒë√£ ƒë∆∞·ª£c thanh to√°n v√† kh√¥ng th·ªÉ s·ª≠a ƒë·ªïi!');
        return;
    }

    // Hi·ªÉn th·ªã form thanh to√°n
    document.getElementById('paymentForm').style.display = 'block';
    
    // C·∫≠p nh·∫≠t ID h√≥a ƒë∆°n v√† t·ªïng ti·ªÅn
    document.getElementById('chi_so_id').value = chiSoId;
    document.getElementById('totalAmount').value = totalAmount;
    
    // Check if there are previous payments
    const previousPaymentText = currentRow.querySelector('.text-success');
    if (previousPaymentText) {
        const previousPaymentInfo = document.getElementById('previousPaymentInfo');
        previousPaymentInfo.style.display = 'block';
        
        // Extract the amount from the text "ƒê√£ tr·∫£: X VNƒê"
        const previousAmountStr = previousPaymentText.textContent.replace(/[^\d]/g, '');
        const previousAmount = parseInt(previousAmountStr, 10) || 0;
        
        document.getElementById('previousAmount').value = previousAmount;
    } else {
        document.getElementById('previousPaymentInfo').style.display = 'none';
        document.getElementById('previousAmount').value = 0;
    }

    document.querySelectorAll('input[name="payment_status"]').forEach(radio => {
        radio.addEventListener('change', () => {
            document.getElementById('debtDetails').style.display = radio.value === 'pending' ? 'block' : 'none';
            if (radio.value === 'pending') calculateRemaining(); // T√≠nh l·∫°i khi ch·ªçn "C√≤n N·ª£"
        });
    });

    // T√≠nh l·∫°i ngay khi m·ªü form n·∫øu ƒë√£ c√≥ debtAmount
    calculateRemaining();
    
    // Set ng√†y h√¥m nay l√†m m·∫∑c ƒë·ªãnh cho h·∫°n tr·∫£
    const today = new Date();
    const nextMonth = new Date(today);
    nextMonth.setMonth(today.getMonth() + 1);
    const formattedDate = nextMonth.toISOString().split('T')[0];
    document.getElementById('dueDate').value = formattedDate;
}

function submitPayment() {
    const form = document.getElementById('payment-form');
    const status = document.querySelector('input[name="payment_status"]:checked')?.value;

    if (!status) {
        alert('Vui l√≤ng ch·ªçn tr·∫°ng th√°i thanh to√°n!');
        return;
    }
    
    // Ki·ªÉm tra d·ªØ li·ªáu n·∫øu thanh to√°n m·ªôt ph·∫ßn
    if (status === 'pending') {
        const debtAmount = document.getElementById('debtAmount').value;
        const dueDate = document.getElementById('dueDate').value;
        
        if (!debtAmount || !dueDate) {
            alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß s·ªë ti·ªÅn kh√°ch ƒë∆∞a v√† h·∫°n tr·∫£!');
            return;
        }
        
        // Ki·ªÉm tra s·ªë ti·ªÅn h·ª£p l·ªá
        const debtAmountValue = parseFloat(debtAmount);
        const totalAmount = parseFloat(document.getElementById('totalAmount').value);
        const previousAmount = parseFloat(document.getElementById('previousAmount').value) || 0;
        
        if (debtAmountValue <= 0) {
            alert('S·ªë ti·ªÅn thanh to√°n ph·∫£i l·ªõn h∆°n 0!');
            return;
        }
        
        if (debtAmountValue + previousAmount > totalAmount) {
            alert('T·ªïng s·ªë ti·ªÅn thanh to√°n kh√¥ng th·ªÉ l·ªõn h∆°n t·ªïng ti·ªÅn h√≥a ƒë∆°n!');
            return;
        }
        
        // If payment would fully cover the invoice, suggest marking as completed
        if (debtAmountValue + previousAmount >= totalAmount) {
            if (confirm('S·ªë ti·ªÅn thanh to√°n ƒë·ªß ƒë·ªÉ thanh to√°n to√†n b·ªô h√≥a ƒë∆°n. B·∫°n c√≥ mu·ªën ƒë√°nh d·∫•u l√† ƒë√£ thanh to√°n ƒë·∫ßy ƒë·ªß?')) {
                document.querySelector('input[value="completed"]').checked = true;
                document.getElementById('debtDetails').style.display = 'none';
            }
        }
    }
    
    // C·∫≠p nh·∫≠t action URL c·ªßa form ƒë·ªÉ g·ª≠i d·ªØ li·ªáu l√™n server
    form.action = '{% url "process_payment" 0 %}'.replace('0', currentChiSoId);
    
    // G·ª≠i form
    form.submit();
}

function cancelPayment() {
    const form = document.getElementById('paymentForm');
    form.style.display = 'none';

    // Reset form
    document.getElementById('chi_so_id').value = '';
    document.getElementById('debtAmount').value = '';
    document.getElementById('total').value = '';
    document.getElementById('dueDate').value = '';
    document.getElementById('previousAmount').value = '';
    document.getElementById('debtDetails').style.display = 'none';
    document.getElementById('previousPaymentInfo').style.display = 'none';
    document.querySelector('input[value="completed"]').checked = true;
}

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.thanhtoan-btn').forEach(button => {
        const row = button.closest('tr');
        const hiddenInput = row.querySelector('#hiddenInput');

        if (hiddenInput && hiddenInput.value === 'ƒê√£ Thanh To√°n') {
            button.textContent = 'ƒê√£ Thanh To√°n';
            button.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t khi t·∫£i trang
        }
    });
});

function filterInvoices() {
    const dayFilter = document.getElementById('dayFilter').value;
    const roomFilter = document.getElementById('roomFilter').value;
    const rows = document.querySelectorAll('#invoiceTable .invoice-row');

    rows.forEach(row => {
        const day = row.getAttribute('data-day');
        const room = row.getAttribute('data-room');

        // Show all rows if "T·∫•t c·∫£" is selected in either filter
        if ((dayFilter === 'T·∫•t c·∫£' || day === dayFilter) && (roomFilter === 'T·∫•t c·∫£' || room === roomFilter)) {
            row.style.display = ''; // Show row
        } else {
            row.style.display = 'none'; // Hide row
        }
    });
}
</script>
</body>
</html>
