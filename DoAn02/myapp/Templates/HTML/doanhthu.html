{% load static %}
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Doanh Thu</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="{% static 'CSS/doanhthu.css' %}" />

    <!--css-->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link href="{% static 'app/css/style.css' %}" rel="stylesheet" />
    <link href="{% static 'app/css/owl.caroysel.min.css' %}" rel="stylesheet" />
    <link href="{% static 'app/css/all.min.css' %}" rel="stylesheet" />
    <!-- js -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
      integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>

    <script src="{% static 'app/js/s3.js' %}"></script>
    <script src="{% static 'app/js/all.min.js' %}"></script>
    <script src="{% static 'app/js/m√Ωcript.js' %}"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <header class="header">
      <div class="menu-toggle">‚ò∞</div>
      <div class="header-title">Nh√† tr·ªç C·∫ßn Th∆°</div>
    </header>

    <div class="sidebar">
      <div class="logo_content">
        <div class="logo">
          <div class="icon">
            <img src="{% static '/imag/moi.jpg' %}" alt="Logo" />
          </div>
          <div class="logo_name">Xin ch√†o, admin</div>
        </div>
      </div>

      <ul class="nav_list">
        <li>
          <a href="{% url 'menu' %}">
            <span class="icon">üè†</span>
            <span class="link_name">Trang ch·ªß</span>
          </a>
        </li>
        <li>
          <a href="{% url 'quan_ly_khach_hang' %}">
            <span class="icon">üßë‚Äçüíº</span>
            <span class="link_name">Qu·∫£n l√Ω kh√°ch h√†ng</span>
          </a>
        </li>
        <li>
          <a href="{% url 'doanh_thu' %}">
            <span class="icon">üí∞</span>
            <span class="link_name">Doanh thu</span>
          </a>
        </li>
        <li>
          <a href="{% url 'dich_vu' %}">
            <span class="icon">üí°</span>
            <span class="link_name">D·ªãch v·ª•</span>
          </a>
        </li>
        <li>
          <a href="{% url 'hoa_don' %}">
            <span class="icon">üßæ</span>
            <span class="link_name">H√≥a ƒë∆°n</span>
          </a>
        </li>
        <li>
          <a href="{% url 'quan_li_hop_dong' %}">
            <span class="icon">üìÇ</span>
            <span class="link_name">Qu·∫£n l√Ω h·ª£p ƒë·ªìng</span>
          </a>
        </li>
        <li>
          <a href="{% url 'dang_xuat' %}" class="logout-link">
            <span class="icon"><i class="fas fa-sign-out-alt"></i></span>
            <span class="link_name">ƒêƒÉng Xu·∫•t</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="content flex-grow-1 p-4">
      <div
        class="topbar d-flex justify-content-between align-items-center mb-4"
      ></div>

      <!-- Th√¢n -->
      <div class="coner">
        <div class="calendar-header">
          <input
            type="month"
            id="current-month-year"
            value="{{ year }}-{{ month|stringformat:'02d' }}"
          />
        </div>

        <div class="dashboard">
          <div class="card">
            <i class="fas fa-chart-line"></i>
            <div
              class="card-content"
              onclick="document.location='themphong.html'"
            >
              <h3>T·ªïng thu th√°ng</h3>
              <p
                class="total-revenue"
                data-value="{{ current_total_revenue|floatformat:0 }}"
              >
                ‚Ç´{{ current_total_revenue|floatformat:0 }}
              </p>
            </div>
          </div>
          <div class="card">
            <i class="fas fa-money-bill-wave"></i>
            <div class="card-content">
              <h3>Chi ti√™u s·ª≠a ch·ªØa</h3>
              <p
                class="repair-cost"
                data-value="{{ current_total_expenses|floatformat:0 }}"
              >
                ‚Ç´{{ current_total_expenses|floatformat:0 }}
              </p>
            </div>
          </div>
          <div class="card">
            <i class="fas fa-exclamation-triangle"></i>
            <div class="card-content" onclick="document.location='hoadon.html'">
              <h3>T·ªïng ti·ªÅn ph√≤ng c√≤n n·ª£</h3>
              <p class="debt" data-value="{{ total_debt|floatformat:0 }}">
                ‚Ç´{{ total_debt|floatformat:0 }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <header class="dau">
        <div class="chart-container">
          <div class="chart-box">
            <div class="title">DOANH THU TH√ÅNG</div>
            <canvas
              id="barChart"
              data-revenue="{{ monthly_revenue|safe }}"
              data-debt="{{ monthly_expenses|safe }}"
            ></canvas>
          </div>
          <div class="chart-box">
            <div class="title">T·ªîNG THU/CHI C·ª¶A TH√ÅNG</div>
            <canvas
              id="barChart2"
              data-income="{{ monthly_revenue|safe }}"
              data-expense="{{ monthly_expenses|safe }}"
            ></canvas>
          </div>
        </div>

        <div class="wrapper">
          <div class="tai">
            <div class="box">
              <div class="tit">
                T·ªîNG THU CHI C·ª¶A NƒÇM <a href="#" class="all">Xem t·∫•t c·∫£</a>
              </div>
              <canvas
                id="lineChart"
                data-total-revenue="{{ yearly_revenue|safe }}"
                data-total-expense="{{ yearly_expenses|safe }}"
                data-years="{{ years|safe }}"
              ></canvas>
            </div>
          </div>

          <div class="calendar-container">
            <div class="calendar-header">
              <span class="arrow" onclick="prevDecade()">‚ùÆ</span>
              <span class="year" id="decadeDisplay">2020 - 2027</span>
              <span class="arrow" onclick="nextDecade()">‚ùØ</span>
            </div>
            <div class="year-list" id="yearList"></div>
          </div>
        </div>
      </header>
    </div>

    <!-- JavaScript -->
    <script>
      // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u tr·ªØ c√°c bi·ªÉu ƒë·ªì
      let barChartInstance = null;
      let barChart2Instance = null;

      // H√†m kh·ªüi t·∫°o bi·ªÉu ƒë·ªì
      function initializeCharts(
        revenueData,
        debtData,
        incomeData,
        expenseData
      ) {
        // H·ªßy bi·ªÉu ƒë·ªì c≈© n·∫øu t·ªìn t·∫°i
        if (barChartInstance) {
          barChartInstance.destroy();
        }
        if (barChart2Instance) {
          barChart2Instance.destroy();
        }

        // Bi·ªÉu ƒë·ªì 1: ƒê√∫ng h·∫°n / N·ª£
        const barChartElement = document.getElementById("barChart");
        const barCtx = barChartElement.getContext("2d");

        barChartInstance = new Chart(barCtx, {
          type: "bar",
          data: {
            labels: [
              "T.1",
              "T.2",
              "T.3",
              "T.4",
              "T.5",
              "T.6",
              "T.7",
              "T.8",
              "T.9",
              "T.10",
              "T.11",
              "T.12",
            ],
            datasets: [
              {
                label: "ƒê√∫ng h·∫°n",
                data: revenueData,
                backgroundColor: "#60a5fa",
              },
              { label: "N·ª£", data: debtData, backgroundColor: "#bfdbfe" },
            ],
          },
          options: {
            scales: {
              y: {
                ticks: {
                  callback: function (value) {
                    return value.toLocaleString("vi-VN") + " VND";
                  },
                },
              },
            },
            animation: false, // T·∫Øt animation ƒë·ªÉ tƒÉng t·ªëc ƒë·ªô v·∫Ω bi·ªÉu ƒë·ªì
          },
        });

        // Bi·ªÉu ƒë·ªì 2: Thu / Chi
        const barChart2Element = document.getElementById("barChart2");
        const barCtx2 = barChart2Element.getContext("2d");

        barChart2Instance = new Chart(barCtx2, {
          type: "bar",
          data: {
            labels: [
              "T.1",
              "T.2",
              "T.3",
              "T.4",
              "T.5",
              "T.6",
              "T.7",
              "T.8",
              "T.9",
              "T.10",
              "T.11",
              "T.12",
            ],
            datasets: [
              { label: "Thu", data: incomeData, backgroundColor: "#67be91" },
              { label: "Chi", data: expenseData, backgroundColor: "#90f7eb" },
            ],
          },
          options: {
            scales: {
              y: {
                ticks: {
                  callback: function (value) {
                    return value.toLocaleString("vi-VN") + " VND";
                  },
                },
              },
            },
            animation: false, // T·∫Øt animation ƒë·ªÉ tƒÉng t·ªëc ƒë·ªô v·∫Ω bi·ªÉu ƒë·ªì
          },
        });

        // Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng: T·ªïng thu chi c·ªßa nƒÉm
        const lineChartElement = document.getElementById("lineChart");
        const totalRevenueData = JSON.parse(
          lineChartElement.getAttribute("data-total-revenue") || "[]"
        );
        const totalExpenseData = JSON.parse(
          lineChartElement.getAttribute("data-total-expense") || "[]"
        );
        const years = JSON.parse(
          lineChartElement.getAttribute("data-years") || "[]"
        );
        const lineCtx = lineChartElement.getContext("2d");

        new Chart(lineCtx, {
          type: "line",
          data: {
            labels: years,
            datasets: [
              {
                label: "T·ªïng thu",
                data: totalRevenueData,
                borderColor: "#60a5fa",
                backgroundColor: "rgba(96, 165, 250, 0.2)",
                fill: true,
              },
              {
                label: "Chi tr·∫£",
                data: totalExpenseData,
                borderColor: "#93c5fd",
                backgroundColor: "rgba(147, 197, 253, 0.2)",
                fill: true,
              },
            ],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return value + " tri·ªáu VND";
                  },
                },
              },
            },
            plugins: {
              legend: {
                display: true,
                position: "top",
                labels: {
                  boxWidth: 20,
                  padding: 20,
                },
              },
            },
            animation: false, // T·∫Øt animation ƒë·ªÉ tƒÉng t·ªëc ƒë·ªô v·∫Ω bi·ªÉu ƒë·ªì
          },
        });
      }

      // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì l·∫ßn ƒë·∫ßu
      window.onload = function () {
        const initialRevenueData = JSON.parse(
          document.getElementById("barChart").getAttribute("data-revenue") ||
            "[]"
        );
        const initialDebtData = JSON.parse(
          document.getElementById("barChart").getAttribute("data-debt") || "[]"
        );
        const initialIncomeData = JSON.parse(
          document.getElementById("barChart2").getAttribute("data-income") ||
            "[]"
        );
        const initialExpenseData = JSON.parse(
          document.getElementById("barChart2").getAttribute("data-expense") ||
            "[]"
        );

        initializeCharts(
          initialRevenueData,
          initialDebtData,
          initialIncomeData,
          initialExpenseData
        );
      };

      // H√†m debounce ƒë·ªÉ tr√°nh g·ª≠i nhi·ªÅu y√™u c·∫ßu AJAX li√™n ti·∫øp
      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi th√°ng v·ªõi debounce
      const fetchData = debounce(function (month, year) {
        fetch("{% url 'doanh_thu' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: `month=${month}&year=${year}`,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            if (data.error) {
              console.error("Server error:", data.error);
              return;
            }

            // C·∫≠p nh·∫≠t d·ªØ li·ªáu trong dashboard
            const totalRevenueElement =
              document.querySelector(".total-revenue");
            const repairCostElement = document.querySelector(".repair-cost");
            const debtElement = document.querySelector(".debt");

            totalRevenueElement.setAttribute(
              "data-value",
              data.current_total_revenue.toLocaleString("vi-VN")
            );
            totalRevenueElement.textContent = `‚Ç´${data.current_total_revenue.toLocaleString(
              "vi-VN"
            )}`;

            repairCostElement.setAttribute(
              "data-value",
              data.current_total_expenses.toLocaleString("vi-VN")
            );
            repairCostElement.textContent = `‚Ç´${data.current_total_expenses.toLocaleString(
              "vi-VN"
            )}`;

            debtElement.setAttribute(
              "data-value",
              data.total_debt.toLocaleString("vi-VN")
            );
            debtElement.textContent = `‚Ç´${data.total_debt.toLocaleString(
              "vi-VN"
            )}`;

            // C·∫≠p nh·∫≠t d·ªØ li·ªáu cho bi·ªÉu ƒë·ªì
            initializeCharts(
              data.monthly_revenue,
              data.monthly_expenses,
              data.monthly_revenue,
              data.monthly_expenses
            );
          })
          .catch((error) => console.error("Error fetching data:", error));
      }, 1); // Debounce 300ms

      document
        .getElementById("current-month-year")
        .addEventListener("change", function () {
          const selectedDate = this.value; // Format: YYYY-MM
          const [year, month] = selectedDate.split("-");
          fetchData(month, year);
        });

      // [Th√™m] H√†m kh·ªüi t·∫°o ho·∫∑c c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì 12 th√°ng c·ªßa nƒÉm ƒë∆∞·ª£c ch·ªçn
      function updateYearlyChart(year) {
        const lineChartElement = document.getElementById("lineChart"); // L·∫•y d·ªØ li·ªáu t·ª´ lineChart
        const yearlyChartElement = document.getElementById("yearlyChart");
        const yearlyCtx = yearlyChartElement.getContext("2d");

        const revenue = JSON.parse(
          lineChartElement.getAttribute(`data-${year}-total-revenue`) || "[]"
        );
        const expense = JSON.parse(
          lineChartElement.getAttribute(`data-${year}-total-expense`) || "[]"
        );

        if (yearlyChart) {
          yearlyChart.destroy();
        }

        yearlyChart = new Chart(yearlyCtx, {
          type: "line",
          data: {
            labels: [
              "T.1",
              "T.2",
              "T.3",
              "T.4",
              "T.5",
              "T.6",
              "T.7",
              "T.8",
              "T.9",
              "T.10",
              "T.11",
              "T.12",
            ],
            datasets: [
              {
                label: "T·ªïng thu",
                data: revenue,
                borderColor: "#60a5fa",
                fill: true,
              },
              {
                label: "Chi tr·∫£",
                data: expense,
                borderColor: "#93c5fd",
                fill: true,
              },
            ],
          },
          options: {
            scales: {
              y: {
                ticks: {
                  callback: function (value) {
                    return value.toLocaleString("vi-VN");
                  },
                },
              },
            },
            plugins: {
              title: {
                display: true,
                text: `T·ªïng Thu/Chi NƒÉm ${year}`,
                font: { size: 16 },
              },
            },
          },
        });
      }

      // L·ªãch nƒÉm
      let startYear = 2020;
      let selectedYear = 2025;

      function renderYearList() {
        document.getElementById(
          "decadeDisplay"
        ).textContent = `${startYear} - ${startYear + 7}`;
        const yearList = document.getElementById("yearList");
        yearList.innerHTML = "";

        for (let i = 0; i < 7; i++) {
          let year = startYear + i;
          let yearElement = document.createElement("div");
          yearElement.classList.add("year");
          yearElement.textContent = year;
          if (year === selectedYear) {
            yearElement.classList.add("selected-year");
          }
          yearElement.onclick = () => {
            selectedYear = year;
            renderYearList();
            updateYearlyChart(selectedYear); // [Th√™m] C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì 12 th√°ng cho nƒÉm ƒë∆∞·ª£c ch·ªçn
          };
          yearList.appendChild(yearElement);
        }
      }

      function prevDecade() {
        startYear -= 7;
        renderYearList();
        updateLineChart(); // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì khi chuy·ªÉn th·∫≠p ni√™n
        updateYearlyChart(selectedYear); // [Th√™m] C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì 12 th√°ng cho nƒÉm ƒë∆∞·ª£c ch·ªçn
      }

      function nextDecade() {
        startYear += 7;
        renderYearList();
        updateLineChart(); // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì khi chuy·ªÉn th·∫≠p ni√™n
        updateYearlyChart(selectedYear); // [Th√™m] C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì 12 th√°ng cho nƒÉm ƒë∆∞·ª£c ch·ªçn
      }

      renderYearList();
      updateLineChart(); // Hi·ªÉn th·ªã bi·ªÉu ƒë·ªì cho kho·∫£ng nƒÉm m·∫∑c ƒë·ªãnh (2020-2026)
      updateYearlyChart(selectedYear); // [Th√™m] Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì 12 th√°ng cho nƒÉm m·∫∑c ƒë·ªãnh
    </script>
  </body>
</html>
