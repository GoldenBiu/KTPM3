{% load static %}
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Doanh Thu</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="{% static 'CSS/doanhthu.css' %}" />

    <!--css-->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link href="{% static 'app/css/style.css' %}" rel="stylesheet" />
    <link href="{% static 'app/css/owl.caroysel.min.css' %}" rel="stylesheet" />
    <link href="{% static 'app/css/all.min.css' %}" rel="stylesheet" />
    <!-- js -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
      integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>

    <script src="{% static 'app/js/s3.js' %}"></script>
    <script src="{% static 'app/js/all.min.js' %}"></script>
    <script src="{% static 'app/js/mÃ½cript.js' %}"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <header class="header">
      <div class="menu-toggle">â˜°</div>
      <div class="header-title">NhÃ  trá» Cáº§n ThÆ¡</div>
    </header>

    <div class="sidebar">
      <div class="logo_content">
        <div class="logo">
          <div class="icon">
            <img src="{% static '/imag/moi.jpg' %}" alt="Logo" />
          </div>
          <div class="logo_name">Xin chÃ o, admin</div>
        </div>
      </div>

      <ul class="nav_list">
        <li>
          <a href="{% url 'menu' %}">
            <span class="icon">ğŸ </span>
            <span class="link_name">Trang chá»§</span>
          </a>
        </li>
        <li>
          <a href="{% url 'quan_ly_khach_hang' %}">
            <span class="icon">ğŸ§‘â€ğŸ’¼</span>
            <span class="link_name">Quáº£n lÃ½ khÃ¡ch hÃ ng</span>
          </a>
        </li>
        <li>
          <a href="{% url 'doanh_thu' %}">
            <span class="icon">ğŸ’°</span>
            <span class="link_name">Doanh thu</span>
          </a>
        </li>
        <li>
          <a href="{% url 'dich_vu' %}">
            <span class="icon">ğŸ’¡</span>
            <span class="link_name">Dá»‹ch vá»¥</span>
          </a>
        </li>
        <li>
          <a href="{% url 'hoa_don' %}">
            <span class="icon">ğŸ§¾</span>
            <span class="link_name">HÃ³a Ä‘Æ¡n</span>
          </a>
        </li>
        <li>
          <a href="{% url 'quan_li_hop_dong' %}">
            <span class="icon">ğŸ“‚</span>
            <span class="link_name">Quáº£n lÃ½ há»£p Ä‘á»“ng</span>
          </a>
        </li>
        <li>
          <a href="{% url 'dang_xuat' %}" class="logout-link">
            <span class="icon"><i class="fas fa-sign-out-alt"></i></span>
            <span class="link_name">ÄÄƒng Xuáº¥t</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="content flex-grow-1 p-4">
      <div
        class="topbar d-flex justify-content-between align-items-center mb-4"
      ></div>

      <!-- ThÃ¢n -->
      <div class="coner">
        <div class="calendar-header">
          <input
            type="month"
            id="current-month-year"
            value="{{ year }}-{{ month|stringformat:'02d' }}"
          />
        </div>

        <div class="dashboard">
          <div class="card">
            <i class="fas fa-chart-line"></i>
            <div
              class="card-content"
              onclick="document.location='themphong.html'"
            >
              <h3>Tá»•ng thu thÃ¡ng</h3>
              <p
                class="total-revenue"
                data-value="{{ current_total_revenue|floatformat:0 }}"
              >
                â‚«{{ current_total_revenue|floatformat:0 }}
              </p>
            </div>
          </div>
          <div class="card">
            <i class="fas fa-money-bill-wave"></i>
            <div class="card-content">
              <h3>Chi tiÃªu sá»­a chá»¯a</h3>
              <p
                class="repair-cost"
                data-value="{{ current_total_expenses|floatformat:0 }}"
              >
                â‚«{{ current_total_expenses|floatformat:0 }}
              </p>
            </div>
          </div>
          <div class="card">
            <i class="fas fa-exclamation-triangle"></i>
            <div class="card-content" onclick="document.location='hoadon.html'">
              <h3>Tá»•ng tiá»n phÃ²ng cÃ²n ná»£</h3>
              <p class="debt" data-value="{{ total_debt|floatformat:0 }}">
                â‚«{{ total_debt|floatformat:0 }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <header class="dau">
        <div class="chart-container">
          <div class="chart-box">
            <div class="title">DOANH THU THÃNG</div>
            <canvas
              id="barChart"
              data-revenue="{{ monthly_revenue|safe }}"
              data-debt="{{ monthly_expenses|safe }}"
            ></canvas>
          </div>
          <div class="chart-box">
            <div class="title">Tá»”NG THU/CHI Cá»¦A THÃNG</div>
            <canvas
              id="barChart2"
              data-income="{{ monthly_revenue|safe }}"
              data-expense="{{ monthly_expenses|safe }}"
            ></canvas>
          </div>
        </div>

        <div class="wrapper">
          <div class="tai">
            <div class="box">
              <div class="tit">
                Tá»”NG THU CHI Cá»¦A NÄ‚M <a href="#" class="all">Xem táº¥t cáº£</a>
              </div>
              <canvas
                id="lineChart"
                data-total-revenue="{{ yearly_revenue|safe }}"
                data-total-expense="{{ yearly_expenses|safe }}"
                data-years="{{ years|safe }}"
              ></canvas>
            </div>
          </div>

          <div class="calendar-container">
            <div class="calendar-header">
              <span class="arrow" onclick="prevDecade()">â®</span>
              <span class="year" id="decadeDisplay">2020 - 2027</span>
              <span class="arrow" onclick="nextDecade()">â¯</span>
            </div>
            <div class="year-list" id="yearList"></div>
          </div>
        </div>
      </header>
    </div>

    <!-- JavaScript -->
    <script>
      // Biáº¿n toÃ n cá»¥c Ä‘á»ƒ lÆ°u trá»¯ cÃ¡c biá»ƒu Ä‘á»“
      let barChartInstance = null;
      let barChart2Instance = null;

      // HÃ m khá»Ÿi táº¡o biá»ƒu Ä‘á»“
      function initializeCharts(
        revenueData,
        debtData,
        incomeData,
        expenseData
      ) {
        // Há»§y biá»ƒu Ä‘á»“ cÅ© náº¿u tá»“n táº¡i
        if (barChartInstance) {
          barChartInstance.destroy();
        }
        if (barChart2Instance) {
          barChart2Instance.destroy();
        }

        // Biá»ƒu Ä‘á»“ 1: ÄÃºng háº¡n / Ná»£
        const barChartElement = document.getElementById("barChart");
        const barCtx = barChartElement.getContext("2d");

        barChartInstance = new Chart(barCtx, {
          type: "bar",
          data: {
            labels: [
              "T.1",
              "T.2",
              "T.3",
              "T.4",
              "T.5",
              "T.6",
              "T.7",
              "T.8",
              "T.9",
              "T.10",
              "T.11",
              "T.12",
            ],
            datasets: [
              {
                label: "ÄÃºng háº¡n",
                data: revenueData,
                backgroundColor: "#60a5fa",
              },
              { label: "Ná»£", data: debtData, backgroundColor: "#bfdbfe" },
            ],
          },
          options: {
            scales: {
              y: {
                ticks: {
                  callback: function (value) {
                    return value.toLocaleString("vi-VN") + " VND";
                  },
                },
              },
            },
            animation: false, // Táº¯t animation Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ váº½ biá»ƒu Ä‘á»“
          },
        });

        // Biá»ƒu Ä‘á»“ 2: Thu / Chi
        const barChart2Element = document.getElementById("barChart2");
        const barCtx2 = barChart2Element.getContext("2d");

        barChart2Instance = new Chart(barCtx2, {
          type: "bar",
          data: {
            labels: [
              "T.1",
              "T.2",
              "T.3",
              "T.4",
              "T.5",
              "T.6",
              "T.7",
              "T.8",
              "T.9",
              "T.10",
              "T.11",
              "T.12",
            ],
            datasets: [
              { label: "Thu", data: incomeData, backgroundColor: "#67be91" },
              { label: "Chi", data: expenseData, backgroundColor: "#90f7eb" },
            ],
          },
          options: {
            scales: {
              y: {
                ticks: {
                  callback: function (value) {
                    return value.toLocaleString("vi-VN") + " VND";
                  },
                },
              },
            },
            animation: false, // Táº¯t animation Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ váº½ biá»ƒu Ä‘á»“
          },
        });

        // Biá»ƒu Ä‘á»“ Ä‘Æ°á»ng: Tá»•ng thu chi cá»§a nÄƒm
        const lineChartElement = document.getElementById("lineChart");
        const totalRevenueData = JSON.parse(
          lineChartElement.getAttribute("data-total-revenue") || "[]"
        );
        const totalExpenseData = JSON.parse(
          lineChartElement.getAttribute("data-total-expense") || "[]"
        );
        const years = JSON.parse(
          lineChartElement.getAttribute("data-years") || "[]"
        );
        const lineCtx = lineChartElement.getContext("2d");

        new Chart(lineCtx, {
          type: "line",
          data: {
            labels: years,
            datasets: [
              {
                label: "Tá»•ng thu",
                data: totalRevenueData,
                borderColor: "#60a5fa",
                backgroundColor: "rgba(96, 165, 250, 0.2)",
                fill: true,
              },
              {
                label: "Chi tráº£",
                data: totalExpenseData,
                borderColor: "#93c5fd",
                backgroundColor: "rgba(147, 197, 253, 0.2)",
                fill: true,
              },
            ],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return value + " triá»‡u VND";
                  },
                },
              },
            },
            plugins: {
              legend: {
                display: true,
                position: "top",
                labels: {
                  boxWidth: 20,
                  padding: 20,
                },
              },
            },
            animation: false, // Táº¯t animation Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ váº½ biá»ƒu Ä‘á»“
          },
        });
      }

      // Khá»Ÿi táº¡o biá»ƒu Ä‘á»“ láº§n Ä‘áº§u
      window.onload = function () {
        const initialRevenueData = JSON.parse(
          document.getElementById("barChart").getAttribute("data-revenue") ||
            "[]"
        );
        const initialDebtData = JSON.parse(
          document.getElementById("barChart").getAttribute("data-debt") || "[]"
        );
        const initialIncomeData = JSON.parse(
          document.getElementById("barChart2").getAttribute("data-income") ||
            "[]"
        );
        const initialExpenseData = JSON.parse(
          document.getElementById("barChart2").getAttribute("data-expense") ||
            "[]"
        );

        initializeCharts(
          initialRevenueData,
          initialDebtData,
          initialIncomeData,
          initialExpenseData
        );
      };

      // HÃ m debounce Ä‘á»ƒ trÃ¡nh gá»­i nhiá»u yÃªu cáº§u AJAX liÃªn tiáº¿p
      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // Láº¯ng nghe sá»± kiá»‡n thay Ä‘á»•i thÃ¡ng vá»›i debounce
      const fetchData = debounce(function (month, year) {
        fetch("{% url 'doanh_thu' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: `month=${month}&year=${year}`,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            if (data.error) {
              console.error("Server error:", data.error);
              return;
            }

            // Cáº­p nháº­t dá»¯ liá»‡u trong dashboard
            const totalRevenueElement =
              document.querySelector(".total-revenue");
            const repairCostElement = document.querySelector(".repair-cost");
            const debtElement = document.querySelector(".debt");

            totalRevenueElement.setAttribute(
              "data-value",
              data.current_total_revenue.toLocaleString("vi-VN")
            );
            totalRevenueElement.textContent = `â‚«${data.current_total_revenue.toLocaleString(
              "vi-VN"
            )}`;

            repairCostElement.setAttribute(
              "data-value",
              data.current_total_expenses.toLocaleString("vi-VN")
            );
            repairCostElement.textContent = `â‚«${data.current_total_expenses.toLocaleString(
              "vi-VN"
            )}`;

            debtElement.setAttribute(
              "data-value",
              data.total_debt.toLocaleString("vi-VN")
            );
            debtElement.textContent = `â‚«${data.total_debt.toLocaleString(
              "vi-VN"
            )}`;

            // Cáº­p nháº­t dá»¯ liá»‡u cho biá»ƒu Ä‘á»“
            initializeCharts(
              data.monthly_revenue,
              data.monthly_expenses,
              data.monthly_revenue,
              data.monthly_expenses
            );
          })
          .catch((error) => console.error("Error fetching data:", error));
      }, 1); // Debounce 300ms

      document
        .getElementById("current-month-year")
        .addEventListener("change", function () {
          const selectedDate = this.value; // Format: YYYY-MM
          const [year, month] = selectedDate.split("-");
          fetchData(month, year);
        });

      // [ThÃªm] HÃ m khá»Ÿi táº¡o hoáº·c cáº­p nháº­t biá»ƒu Ä‘á»“ 12 thÃ¡ng cá»§a nÄƒm Ä‘Æ°á»£c chá»n
      function updateYearlyChart(year) {
        const lineChartElement = document.getElementById("lineChart"); // Láº¥y dá»¯ liá»‡u tá»« lineChart
        const yearlyChartElement = document.getElementById("yearlyChart");
        const yearlyCtx = yearlyChartElement.getContext("2d");

        const revenue = JSON.parse(
          lineChartElement.getAttribute(`data-${year}-total-revenue`) || "[]"
        );
        const expense = JSON.parse(
          lineChartElement.getAttribute(`data-${year}-total-expense`) || "[]"
        );

        if (yearlyChart) {
          yearlyChart.destroy();
        }

        yearlyChart = new Chart(yearlyCtx, {
          type: "line",
          data: {
            labels: [
              "T.1",
              "T.2",
              "T.3",
              "T.4",
              "T.5",
              "T.6",
              "T.7",
              "T.8",
              "T.9",
              "T.10",
              "T.11",
              "T.12",
            ],
            datasets: [
              {
                label: "Tá»•ng thu",
                data: revenue,
                borderColor: "#60a5fa",
                fill: true,
              },
              {
                label: "Chi tráº£",
                data: expense,
                borderColor: "#93c5fd",
                fill: true,
              },
            ],
          },
          options: {
            scales: {
              y: {
                ticks: {
                  callback: function (value) {
                    return value.toLocaleString("vi-VN");
                  },
                },
              },
            },
            plugins: {
              title: {
                display: true,
                text: `Tá»•ng Thu/Chi NÄƒm ${year}`,
                font: { size: 16 },
              },
            },
          },
        });
      }

      // Lá»‹ch nÄƒm
      let startYear = 2020;
      let selectedYear = 2025;

      function renderYearList() {
        document.getElementById(
          "decadeDisplay"
        ).textContent = `${startYear} - ${startYear + 7}`;
        const yearList = document.getElementById("yearList");
        yearList.innerHTML = "";

        for (let i = 0; i < 7; i++) {
          let year = startYear + i;
          let yearElement = document.createElement("div");
          yearElement.classList.add("year");
          yearElement.textContent = year;
          if (year === selectedYear) {
            yearElement.classList.add("selected-year");
          }
          yearElement.onclick = () => {
            selectedYear = year;
            renderYearList();
            updateYearlyChart(selectedYear); // [ThÃªm] Cáº­p nháº­t biá»ƒu Ä‘á»“ 12 thÃ¡ng cho nÄƒm Ä‘Æ°á»£c chá»n
          };
          yearList.appendChild(yearElement);
        }
      }

      function prevDecade() {
        startYear -= 7;
        renderYearList();
        updateLineChart(); // Cáº­p nháº­t biá»ƒu Ä‘á»“ khi chuyá»ƒn tháº­p niÃªn
        updateYearlyChart(selectedYear); // [ThÃªm] Cáº­p nháº­t biá»ƒu Ä‘á»“ 12 thÃ¡ng cho nÄƒm Ä‘Æ°á»£c chá»n
      }

      function nextDecade() {
        startYear += 7;
        renderYearList();
        updateLineChart(); // Cáº­p nháº­t biá»ƒu Ä‘á»“ khi chuyá»ƒn tháº­p niÃªn
        updateYearlyChart(selectedYear); // [ThÃªm] Cáº­p nháº­t biá»ƒu Ä‘á»“ 12 thÃ¡ng cho nÄƒm Ä‘Æ°á»£c chá»n
      }

      renderYearList();
      updateLineChart(); // Hiá»ƒn thá»‹ biá»ƒu Ä‘á»“ cho khoáº£ng nÄƒm máº·c Ä‘á»‹nh (2020-2026)
      updateYearlyChart(selectedYear); // [ThÃªm] Khá»Ÿi táº¡o biá»ƒu Ä‘á»“ 12 thÃ¡ng cho nÄƒm máº·c Ä‘á»‹nh
    </script>
  </body>
</html>
